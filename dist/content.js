(()=>{"use strict";class e{constructor(){this.authToken=null}static getInstance(){return e.instance||(e.instance=new e),e.instance}setAuthToken(e){this.authToken=e}getAuthToken(){return this.authToken}clearAuthToken(){this.authToken=null}async makeRequest(e,t={}){const n=`http://127.0.0.1:8000/api${e}`,o={"Content-Type":"application/json"};this.authToken&&(o.Authorization=`Token ${this.authToken.token}`);try{const e=await fetch(n,{...t,headers:{...o,...t.headers}}),s=await e.json();return e.ok?{success:!0,data:s}:{success:!1,error:s.error||s.message||`HTTP ${e.status}`}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error"}}}async login(e,t){const n=await this.makeRequest("/users/login/",{method:"POST",body:JSON.stringify({username:e,password:t})});return n.success&&n.data?{success:!0,data:{token:{token:n.data.token,expiresAt:Date.now()+864e5,userId:n.data.user_id.toString()},user:{id:n.data.user_id.toString(),email:"",name:n.data.username}}}:n}async signup(e,t,n,o){const s=await this.makeRequest("/users/register/",{method:"POST",body:JSON.stringify({username:e,email:t,password:n,first_name:o.split(" ")[0]||o,last_name:o.split(" ").slice(1).join(" ")||""})});return s.success&&s.data?{success:!0,data:{token:{token:s.data.token,expiresAt:Date.now()+864e5,userId:s.data.user_id.toString()},user:{id:s.data.user_id.toString(),email:t,name:s.data.username}}}:s}async logout(){return this.makeRequest("/users/logout/",{method:"POST"})}async getPlayerDataByName(e){return this.makeRequest(`/players/data/${encodeURIComponent(e)}/`)}async getBulkPlayerData(e){return this.makeRequest("/players/bulk-data/",{method:"POST",body:JSON.stringify({player_names:e})})}async getCurrentUser(){const e=await this.makeRequest("/users/validate-token/");return e.success&&e.data?{success:!0,data:{id:e.data.user_id.toString(),email:"",name:e.data.username}}:e}}const t="auth_token",n="user_data";class o{constructor(){}static getInstance(){return o.instance||(o.instance=new o),o.instance}async get(e){try{return(await chrome.storage.local.get(e))[e]||null}catch(e){return console.error("Error getting from storage:",e),null}}async set(e,t){try{await chrome.storage.local.set({[e]:t})}catch(e){console.error("Error setting storage:",e)}}async remove(e){try{await chrome.storage.local.remove(e)}catch(e){console.error("Error removing from storage:",e)}}async clear(){try{await chrome.storage.local.clear()}catch(e){console.error("Error clearing storage:",e)}}async getAuthToken(){const e=await this.get(t);return e?Date.now()>e.expiresAt?(await this.clearAuthToken(),null):e:null}async setAuthToken(e){await this.set(t,e)}async clearAuthToken(){await this.remove(t)}async getUserData(){return this.get(n)}async setUserData(e){await this.set(n,e)}async clearUserData(){await this.remove(n)}}class s{}const a=".playerinfo__playername";class r{constructor(e){this.root=e}getName(){const e=this.root.querySelector(a);if(!e)return"";const t=e.cloneNode(!0);return t.querySelectorAll(".drafty-action-btn").forEach(e=>e.remove()),t.textContent?.trim()||""}setNote(e){console.log(`Setting note for ${this.getName()}: ${e}`)}addActionButton(e){if(this.root.querySelector(".drafty-action-btn"))return;const t=this.root.querySelector(a);if(!t)return;const n=document.createElement("button");n.className="drafty-action-btn",n.title="Get player insights";const o=chrome.runtime.getURL("assets/drafty_logo_d.svg"),s=document.createElement("img");s.src=o,s.style.cssText="\n      width: 12px;\n      height: 12px;\n      filter: brightness(0) invert(1);\n    ",n.appendChild(s),n.style.cssText="\n      background: #87CEEB;\n      color: white;\n      border: none;\n      border-radius: 3px;\n      padding: 2px;\n      width: 18px;\n      height: 18px;\n      cursor: pointer;\n      margin-left: 8px;\n      margin-top: 2px;\n      transition: background-color 0.2s;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      vertical-align: text-bottom;\n    ",n.addEventListener("mouseenter",()=>{n.style.background="#5F9EA0"}),n.addEventListener("mouseleave",()=>{n.style.background="#87CEEB"}),n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e()});const r=t.closest(".flex");if(r&&!r.querySelector(".drafty-action-btn"))r.appendChild(n);else{const e=t.parentElement;e&&!e.querySelector(".drafty-action-btn")&&e.insertBefore(n,t.nextSibling)}}}class i extends s{constructor(){super(...arguments),this.name="ESPN"}canParse(e){return e.includes("fantasy.espn.com/football/draft")}getPlayerRows(){const e=document.querySelector(".draft-players");if(!e)return[];const t=e.querySelectorAll(a);if(0===t.length)return[];const n=new Set;return t.forEach(e=>{const t=e.closest('[role="row"]')||e.closest("tr")||e.closest('[class*="row"]')||e.closest('div[class*="row"]');t&&n.add(t)}),Array.from(n).map(e=>new r(e))}findScrollbar(){const e=document.querySelector(".draft-players");return e?e.querySelector(".ScrollbarLayout_main.ScrollbarLayout_mainVertical.public_Scrollbar_main"):null}findScrollbarFace(){const e=document.querySelector(".draft-players");return e?e.querySelector(".ScrollbarLayout_face.ScrollbarLayout_faceVertical.public_Scrollbar_face"):null}async scrollToTop(){const e=this.findScrollbarFace(),t=this.findScrollbar();if(!e||!t)return;const n=e.getBoundingClientRect(),o=t.getBoundingClientRect(),s=n.left+n.width/2,a=n.top+n.height/2,r=o.left+o.width/2,i=o.top+10,l=new MouseEvent("mousedown",{clientX:s,clientY:a,bubbles:!0,cancelable:!0,button:0}),c=new MouseEvent("mousemove",{clientX:r,clientY:i,bubbles:!0,cancelable:!0}),d=new MouseEvent("mouseup",{clientX:r,clientY:i,bubbles:!0,cancelable:!0,button:0});e.dispatchEvent(l),await new Promise(e=>setTimeout(e,50)),e.dispatchEvent(c),await new Promise(e=>setTimeout(e,50)),e.dispatchEvent(d)}async scrollDown(){const e=this.findScrollbarFace();if(!e)return;const t=e.getBoundingClientRect(),n=t.top+t.height/2,o=n+10,s=t.left+t.width/2,a=new MouseEvent("mousedown",{clientX:s,clientY:n,bubbles:!0,cancelable:!0,button:0}),r=new MouseEvent("mousemove",{clientX:s,clientY:o,bubbles:!0,cancelable:!0}),i=new MouseEvent("mouseup",{clientX:s,clientY:o,bubbles:!0,cancelable:!0,button:0});e.dispatchEvent(a),await new Promise(e=>setTimeout(e,50)),e.dispatchEvent(r),await new Promise(e=>setTimeout(e,50)),e.dispatchEvent(i)}getCurrentPlayerNames(){const e=this.getPlayerRows(),t=new Set;for(const n of e){const e=n.getName().trim();e&&t.add(e)}return Array.from(t)}async getPlayerNames(e){console.log(`ESPN Parser: Getting ${e} player names`),await this.scrollToTop(),await new Promise(e=>setTimeout(e,300));const t=new Set;let n=0;for(;n<100&&t.size<e&&(this.getCurrentPlayerNames().forEach(e=>t.add(e)),console.log(`ESPN Parser: Found ${t.size} unique player names (needed ${e})`),!(t.size>=e));)await this.scrollDown(),await new Promise(e=>setTimeout(e,200)),n++;return await this.scrollToTop(),console.log(`ESPN Parser: Final collection: ${t.size} player names`),Array.from(t)}}class l{constructor(){this.parsers=[],this.registerParsers()}static getInstance(){return l.instance||(l.instance=new l),l.instance}registerParsers(){this.parsers.push(new i)}getParserForUrl(e){return this.parsers.find(t=>t.canParse(e))||null}getPlayerRows(e){const t=this.getParserForUrl(e);return t?t.getPlayerRows():[]}}class c{constructor(){this.observer=null,this.isInitialized=!1,this.floatingButton=null,this.isDragging=!1,this.dragOffset={x:0,y:0},this.apiService=e.getInstance(),this.storageService=o.getInstance(),this.parserManager=l.getInstance()}async init(){this.isInitialized||(await this.initializeAuth(),this.setupObserver(),this.addButtonsToAllRows(),this.createFloatingButton(),this.isInitialized=!0)}async initializeAuth(){const e=await this.storageService.getAuthToken();e&&this.apiService.setAuthToken(e)}setupObserver(){this.observer=new MutationObserver(()=>{this.addButtonsToAllRows()}),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style"]})}addButtonsToAllRows(){const e=window.location.href;this.parserManager.getPlayerRows(e).forEach(e=>{e.getName().trim()&&e.addActionButton(()=>{this.handlePlayerClick(e)})})}async handlePlayerClick(e){const t=e.getName();if(t)try{if(!await this.storageService.getAuthToken())return void this.showError("Please log in to get player insights");const n=await this.apiService.getPlayerDataByName(t);n.success&&n.data?this.showPlayerData(e.root,t,n.data):this.showError(`Failed to get data for ${t}: ${n.error}`)}catch(e){console.error("Error handling player action:",e),this.showError("An error occurred while fetching player data")}else this.showError("Could not find player name")}showPlayerData(e,t,n){const o=document.querySelector(".drafty-popup");o&&o.remove();const s=document.createElement("div");s.className="drafty-popup",s.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: white;\n      border: 1px solid #ccc;\n      border-radius: 8px;\n      padding: 20px;\n      z-index: 10001;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n      max-width: 400px;\n      max-height: 80vh;\n      overflow-y: auto;\n    ";const a=document.createElement("h3");a.textContent=`${t} - Player Insights`,a.style.cssText="\n      margin: 0 0 15px 0;\n      color: #333;\n      font-size: 18px;\n      border-bottom: 2px solid #007bff;\n      padding-bottom: 8px;\n    ";const r=document.createElement("div");if(n.rank){const e=document.createElement("div");e.style.cssText="margin-bottom: 10px;",e.innerHTML=`<strong>Rank:</strong> ${n.rank}`,r.appendChild(e)}const i=n.insights||[];if(i.length>0){const e=document.createElement("div");e.style.cssText="margin-bottom: 10px;",e.innerHTML="<strong>Insights:</strong>";const t=document.createElement("ul");t.style.cssText="margin: 5px 0 0 20px; padding: 0;",i.forEach(e=>{const n=document.createElement("li");n.textContent=e.message||e,n.style.cssText="margin-bottom: 5px;",t.appendChild(n)}),e.appendChild(t),r.appendChild(e)}if(n.additionalData){const e=document.createElement("div");e.style.cssText="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;",e.innerHTML=`<strong>Additional Data:</strong><br>${JSON.stringify(n.additionalData,null,2)}`,r.appendChild(e)}const l=document.createElement("button");l.textContent="Close",l.style.cssText="\n      background: #6c757d;\n      color: white;\n      border: none;\n      border-radius: 4px;\n      padding: 8px 16px;\n      cursor: pointer;\n      margin-top: 15px;\n      font-size: 14px;\n    ",l.addEventListener("click",()=>{s.remove()}),s.addEventListener("click",e=>{e.target===s&&s.remove()});const c=e=>{"Escape"===e.key&&(s.remove(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),s.appendChild(a),s.appendChild(r),s.appendChild(l);const d=document.createElement("div");d.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0,0,0,0.5);\n      z-index: 10000;\n    ",d.addEventListener("click",()=>{d.remove(),s.remove(),document.removeEventListener("keydown",c)}),document.body.appendChild(d),document.body.appendChild(s)}showError(e){const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #dc3545;\n      color: white;\n      padding: 12px 16px;\n      border-radius: 4px;\n      z-index: 10000;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n    ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},3e3)}createFloatingButton(){const e=document.querySelector(".drafty-floating-btn");if(e&&e.remove(),!document.querySelector("#drafty-floating-styles")){const e=document.createElement("style");e.id="drafty-floating-styles",e.textContent="\n        .drafty-spinner {\n          width: 16px;\n          height: 16px;\n          border: 2px solid rgba(255,255,255,0.3);\n          border-top: 2px solid white;\n          border-radius: 50%;\n          animation: drafty-spin 1s linear infinite;\n        }\n        \n        @keyframes drafty-spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n        \n        .drafty-floating-btn-content {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n        }\n      ",document.head.appendChild(e)}this.floatingButton=document.createElement("div"),this.floatingButton.className="drafty-floating-btn",this.floatingButton.innerHTML='\n      <div class="drafty-floating-btn-content">\n        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="currentColor"/>\n        </svg>\n        <span>Get Top 25</span>\n      </div>\n    ',this.floatingButton.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      border: none;\n      border-radius: 50px;\n      padding: 12px 20px;\n      cursor: pointer;\n      z-index: 10000;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      font-weight: 600;\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n      transition: all 0.3s ease;\n      user-select: none;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    ",this.floatingButton.addEventListener("mouseenter",()=>{this.floatingButton&&(this.floatingButton.style.transform="scale(1.05)",this.floatingButton.style.boxShadow="0 6px 25px rgba(0,0,0,0.4)")}),this.floatingButton.addEventListener("mouseleave",()=>{this.floatingButton&&(this.floatingButton.style.transform="scale(1)",this.floatingButton.style.boxShadow="0 4px 20px rgba(0,0,0,0.3)")}),this.floatingButton.addEventListener("click",e=>{this.isDragging||this.handleFloatingButtonClick()}),this.setupDragFunctionality(),document.body.appendChild(this.floatingButton)}setupDragFunctionality(){this.floatingButton&&this.floatingButton.addEventListener("mousedown",e=>{e.preventDefault(),this.isDragging=!1;const t=this.floatingButton.getBoundingClientRect();this.dragOffset.x=e.clientX-t.left,this.dragOffset.y=e.clientY-t.top;const n=e=>{e.preventDefault(),this.isDragging=!0,requestAnimationFrame(()=>{const t=e.clientX-this.dragOffset.x,n=e.clientY-this.dragOffset.y,o=window.innerWidth-this.floatingButton.offsetWidth,s=window.innerHeight-this.floatingButton.offsetHeight,a=Math.max(0,Math.min(t,o)),r=Math.max(0,Math.min(n,s));this.floatingButton.style.left=`${a}px`,this.floatingButton.style.top=`${r}px`,this.floatingButton.style.right="auto"})},o=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o),setTimeout(()=>{this.isDragging=!1},50)};document.addEventListener("mousemove",n,{passive:!1}),document.addEventListener("mouseup",o)})}async handleFloatingButtonClick(){try{console.log("🚀 Floating button clicked, starting player collection..."),this.showLoadingOverlay("Searching available players");const e=window.location.href,t=this.parserManager.getParserForUrl(e);if(!t)return console.log("❌ No parser found for this URL"),this.hideLoadingOverlay(),void this.showError("No parser found for this URL");console.log("🔍 Starting to collect players...");const n=await t.getPlayerNames(100);if(console.log(`📊 Found ${n.length} player names`),this.hideLoadingOverlay(),0===n.length)return console.log("❌ No players found on this page"),void this.showError("No players found on this page");this.showLoadingOverlay("Analyzing possible picks"),console.log("🌐 Calling API with player names:",n);const o=await this.apiService.getBulkPlayerData(n);console.log("📡 API response received:",o),this.hideLoadingOverlay(),o.success&&o.data?(console.log("✅ API call successful, showing bulk player data"),this.showBulkPlayerData(n,o.data)):(console.log("❌ API call failed:",o.error),this.showError(`Failed to get player data: ${o.error}`))}catch(e){console.error("💥 Error handling floating button click:",e),this.hideLoadingOverlay(),this.showError("An error occurred while fetching player data")}}showLoadingOverlay(e){this.hideLoadingOverlay();const t=document.createElement("div");t.id="drafty-loading-overlay",t.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100vw;\n      height: 100vh;\n      background: rgba(0, 0, 0, 0.7);\n      z-index: 2147483647;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      pointer-events: auto;\n      user-select: none;\n    ";const n=document.createElement("div");n.style.cssText="\n      width: 50px;\n      height: 50px;\n      border: 4px solid rgba(255, 255, 255, 0.3);\n      border-top: 4px solid #87CEEB;\n      border-radius: 50%;\n      animation: drafty-spin 1s linear infinite;\n    ";const o=document.createElement("div");o.textContent=e,o.style.cssText="\n      color: white;\n      margin-top: 20px;\n      font-family: Arial, sans-serif;\n      font-size: 16px;\n    ";const s=document.createElement("style");s.textContent="\n      @keyframes drafty-spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n    ",document.head.appendChild(s);const a=document.createElement("div");a.style.cssText="\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n    ",a.appendChild(n),a.appendChild(o),t.appendChild(a);const r=e=>(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1);["mousedown","mouseup","mousemove","click","dblclick","contextmenu","wheel","scroll","keydown","keyup","keypress","touchstart","touchend","touchmove","dragstart","drag","dragend","drop","focus","blur","input","change","submit","reset","select","selectstart"].forEach(e=>{t.addEventListener(e,r,{capture:!0,passive:!1})}),document.body.appendChild(t)}hideLoadingOverlay(){const e=document.getElementById("drafty-loading-overlay");e&&e.remove();const t=document.querySelector("style");t&&t.textContent?.includes("drafty-spin")&&t.remove()}showBulkPlayerData(e,t){const n=document.querySelector(".drafty-bulk-popup");n&&n.remove();const o=document.createElement("div");o.className="drafty-bulk-popup",o.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: white;\n      border: 1px solid #ccc;\n      border-radius: 12px;\n      padding: 24px;\n      z-index: 10001;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n      max-width: 600px;\n      max-height: 80vh;\n      overflow-y: auto;\n    ";const s=document.createElement("h3");s.textContent=`Top ${e.length} Players - Insights`,s.style.cssText="\n      margin: 0 0 20px 0;\n      color: #333;\n      font-size: 20px;\n      border-bottom: 2px solid #667eea;\n      padding-bottom: 12px;\n    ";const a=document.createElement("div"),r=t.players||[];if(0===r.length){const e=document.createElement("div");e.style.cssText="text-align: center; color: #666; padding: 20px;",e.textContent="No player data available",a.appendChild(e)}else{const e=document.createElement("div");e.style.cssText="margin-bottom: 20px;",r.forEach((t,n)=>{const o=document.createElement("div");o.style.cssText="\n          padding: 12px;\n          border: 1px solid #eee;\n          border-radius: 8px;\n          margin-bottom: 8px;\n          background: #f8f9fa;\n        ";const s=document.createElement("div");if(s.style.cssText="font-weight: 600; margin-bottom: 8px; color: #333;",t.error)s.textContent=`${n+1}. ${t.name} - Not Found`,s.style.color="#dc3545";else if(s.textContent=`${n+1}. ${t.full_name||t.name}`,t.position||t.team){const e=document.createElement("div");e.style.cssText="font-size: 12px; color: #666; margin-top: 4px;",e.textContent=`${t.position||""} ${t.team||""}`.trim(),o.appendChild(e)}if(t.insights&&t.insights.length>0){const e=document.createElement("ul");e.style.cssText="margin: 8px 0 0 0; padding-left: 20px; color: #666;",t.insights.forEach(t=>{const n=document.createElement("li");n.textContent=t.message||t,n.style.cssText="margin-bottom: 4px;",e.appendChild(n)}),o.appendChild(e)}else if(!t.error){const e=document.createElement("div");e.style.cssText="font-size: 12px; color: #999; margin-top: 4px; font-style: italic;",e.textContent="No insights available",o.appendChild(e)}o.appendChild(s),e.appendChild(o)}),a.appendChild(e)}const i=document.createElement("button");i.textContent="Close",i.style.cssText="\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      border: none;\n      border-radius: 6px;\n      padding: 10px 20px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 600;\n      transition: all 0.3s ease;\n    ",i.addEventListener("mouseenter",()=>{i.style.transform="scale(1.02)"}),i.addEventListener("mouseleave",()=>{i.style.transform="scale(1)"}),i.addEventListener("click",()=>{o.remove()}),o.addEventListener("click",e=>{e.target===o&&o.remove()});const l=e=>{"Escape"===e.key&&(o.remove(),document.removeEventListener("keydown",l))};document.addEventListener("keydown",l),o.appendChild(s),o.appendChild(a),o.appendChild(i);const c=document.createElement("div");c.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0,0,0,0.5);\n      z-index: 10000;\n    ",c.addEventListener("click",()=>{c.remove(),o.remove(),document.removeEventListener("keydown",l)}),document.body.appendChild(c),document.body.appendChild(o)}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null);const e=document.querySelector(".drafty-popup");e&&e.remove();const t=document.querySelector('div[style*="rgba(0,0,0,0.5)"]');t&&t.remove(),this.floatingButton&&(this.floatingButton.remove(),this.floatingButton=null),this.isInitialized=!1}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{(new c).init()}):(new c).init()})();