(()=>{"use strict";class e{constructor(){this.authToken=null}static getInstance(){return e.instance||(e.instance=new e),e.instance}setAuthToken(e){this.authToken=e}getAuthToken(){return this.authToken}clearAuthToken(){this.authToken=null}async makeRequest(e,t={}){const n=`http://127.0.0.1:8000/api${e}`,r={"Content-Type":"application/json"};this.authToken&&(r.Authorization=`Token ${this.authToken.token}`);try{const e=await fetch(n,{...t,headers:{...r,...t.headers}}),s=await e.json();return e.ok?{success:!0,data:s}:{success:!1,error:s.error||s.message||`HTTP ${e.status}`}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error"}}}async login(e,t){const n=await this.makeRequest("/users/login/",{method:"POST",body:JSON.stringify({username:e,password:t})});return n.success&&n.data?{success:!0,data:{token:{token:n.data.token,expiresAt:Date.now()+864e5,userId:n.data.user_id.toString()},user:{id:n.data.user_id.toString(),email:"",name:n.data.username}}}:n}async signup(e,t,n,r){const s=await this.makeRequest("/users/register/",{method:"POST",body:JSON.stringify({username:e,email:t,password:n,first_name:r.split(" ")[0]||r,last_name:r.split(" ").slice(1).join(" ")||""})});return s.success&&s.data?{success:!0,data:{token:{token:s.data.token,expiresAt:Date.now()+864e5,userId:s.data.user_id.toString()},user:{id:s.data.user_id.toString(),email:t,name:s.data.username}}}:s}async logout(){return this.makeRequest("/users/logout/",{method:"POST"})}async getPlayerDataByName(e){return this.makeRequest(`/players/data/${encodeURIComponent(e)}/`)}async getCurrentUser(){const e=await this.makeRequest("/users/validate-token/");return e.success&&e.data?{success:!0,data:{id:e.data.user_id.toString(),email:"",name:e.data.username}}:e}}const t="auth_token",n="user_data";class r{constructor(){}static getInstance(){return r.instance||(r.instance=new r),r.instance}async get(e){try{return(await chrome.storage.local.get(e))[e]||null}catch(e){return console.error("Error getting from storage:",e),null}}async set(e,t){try{await chrome.storage.local.set({[e]:t})}catch(e){console.error("Error setting storage:",e)}}async remove(e){try{await chrome.storage.local.remove(e)}catch(e){console.error("Error removing from storage:",e)}}async clear(){try{await chrome.storage.local.clear()}catch(e){console.error("Error clearing storage:",e)}}async getAuthToken(){const e=await this.get(t);return e?Date.now()>e.expiresAt?(await this.clearAuthToken(),null):e:null}async setAuthToken(e){await this.set(t,e)}async clearAuthToken(){await this.remove(t)}async getUserData(){return this.get(n)}async setUserData(e){await this.set(n,e)}async clearUserData(){await this.remove(n)}}class s{constructor(e){this.root=e,this.nameSelectors=[".playerinfo__playername",".player-name",'[data-testid="player-name"]']}getName(){for(const e of this.nameSelectors){const t=this.root.querySelector(e);if(t){const e=t.cloneNode(!0);e.querySelectorAll(".drafty-action-btn").forEach(e=>e.remove());const n=e.textContent?.trim()||"";if(n)return n}}const e=this.root.cloneNode(!0);return e.querySelectorAll(".drafty-action-btn").forEach(e=>e.remove()),e.textContent?.trim()||""}setNote(e){console.log(`Setting note for ${this.getName()}: ${e}`)}addActionButton(e){if(this.root.querySelector(".drafty-action-btn"))return;const t=this.nameSelectors.map(e=>this.root.querySelector(e)).find(Boolean);if(!t)return;const n=document.createElement("button");n.className="drafty-action-btn",n.title="Get player insights";const r=chrome.runtime.getURL("assets/drafty_logo_d.svg"),s=document.createElement("img");s.src=r,s.style.cssText="\n      width: 12px;\n      height: 12px;\n      filter: brightness(0) invert(1);\n    ",n.appendChild(s),n.style.cssText="\n      background: #87CEEB;\n      color: white;\n      border: none;\n      border-radius: 3px;\n      padding: 2px;\n      width: 18px;\n      height: 18px;\n      cursor: pointer;\n      margin-left: 8px;\n      margin-top: 2px;\n      transition: background-color 0.2s;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      vertical-align: text-bottom;\n    ",n.addEventListener("mouseenter",()=>{n.style.background="#5F9EA0"}),n.addEventListener("mouseleave",()=>{n.style.background="#87CEEB"}),n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e()});const o=t.closest(".flex");if(o&&!o.querySelector(".drafty-action-btn"))o.appendChild(n);else{const e=t.parentElement;e&&!e.querySelector(".drafty-action-btn")&&e.insertBefore(n,t.nextSibling)}}}class o{constructor(){this.name="ESPN"}canParse(e){return e.includes("fantasy.espn.com/football/draft")}getPlayerRows(){const e=document.querySelector(".draft-players");if(!e)return[];const t=e.querySelectorAll('[role="row"]');if(0===t.length){const t=["tr",'[class*="row"]','[class*="player"]','div[class*="row"]'];for(const n of t){const t=e.querySelectorAll(n);if(t.length>0)return Array.from(t).map(e=>new s(e))}return[]}return Array.from(t).map(e=>new s(e))}async getPlayerData(e){return null}}class a{constructor(){this.parsers=[],this.registerParsers()}static getInstance(){return a.instance||(a.instance=new a),a.instance}registerParsers(){this.parsers.push(new o)}getParserForUrl(e){return this.parsers.find(t=>t.canParse(e))||null}getPlayerRows(e){const t=this.getParserForUrl(e);return t?t.getPlayerRows():[]}}class i{constructor(){this.observer=null,this.isInitialized=!1,this.apiService=e.getInstance(),this.storageService=r.getInstance(),this.parserManager=a.getInstance()}async init(){this.isInitialized||(await this.initializeAuth(),this.setupObserver(),this.setupScrollListener(),this.addButtonsToAllRows(),this.isInitialized=!0)}async initializeAuth(){const e=await this.storageService.getAuthToken();e&&this.apiService.setAuthToken(e)}setupObserver(){this.observer=new MutationObserver(()=>{this.addButtonsToAllRows()}),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style"]})}setupScrollListener(){document.addEventListener("scroll",()=>{this.addButtonsToAllRows()},{passive:!0}),document.addEventListener("scroll",e=>{e.target!==document&&this.addButtonsToAllRows()},{passive:!0,capture:!0})}addButtonsToAllRows(){const e=window.location.href;this.parserManager.getPlayerRows(e).forEach(e=>{e.addActionButton(()=>{this.handlePlayerClick(e)})})}async handlePlayerClick(e){const t=e.getName();if(t)try{if(!await this.storageService.getAuthToken())return void this.showError("Please log in to get player insights");const n=await this.apiService.getPlayerDataByName(t);n.success&&n.data?this.showPlayerData(e.root,t,n.data):this.showError(`Failed to get data for ${t}: ${n.error}`)}catch(e){console.error("Error handling player action:",e),this.showError("An error occurred while fetching player data")}else this.showError("Could not find player name")}showPlayerData(e,t,n){const r=document.querySelector(".drafty-popup");r&&r.remove();const s=document.createElement("div");s.className="drafty-popup",s.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: white;\n      border: 1px solid #ccc;\n      border-radius: 8px;\n      padding: 20px;\n      z-index: 10001;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n      max-width: 400px;\n      max-height: 80vh;\n      overflow-y: auto;\n    ";const o=document.createElement("h3");o.textContent=`${t} - Player Insights`,o.style.cssText="\n      margin: 0 0 15px 0;\n      color: #333;\n      font-size: 18px;\n      border-bottom: 2px solid #007bff;\n      padding-bottom: 8px;\n    ";const a=document.createElement("div");if(n.rank){const e=document.createElement("div");e.style.cssText="margin-bottom: 10px;",e.innerHTML=`<strong>Rank:</strong> ${n.rank}`,a.appendChild(e)}const i=n.insights||[];if(i.length>0){const e=document.createElement("div");e.style.cssText="margin-bottom: 10px;",e.innerHTML="<strong>Insights:</strong>";const t=document.createElement("ul");t.style.cssText="margin: 5px 0 0 20px; padding: 0;",i.forEach(e=>{const n=document.createElement("li");n.textContent=e.message||e,n.style.cssText="margin-bottom: 5px;",t.appendChild(n)}),e.appendChild(t),a.appendChild(e)}if(n.additionalData){const e=document.createElement("div");e.style.cssText="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;",e.innerHTML=`<strong>Additional Data:</strong><br>${JSON.stringify(n.additionalData,null,2)}`,a.appendChild(e)}const c=document.createElement("button");c.textContent="Close",c.style.cssText="\n      background: #6c757d;\n      color: white;\n      border: none;\n      border-radius: 4px;\n      padding: 8px 16px;\n      cursor: pointer;\n      margin-top: 15px;\n      font-size: 14px;\n    ",c.addEventListener("click",()=>{s.remove()}),s.addEventListener("click",e=>{e.target===s&&s.remove()});const l=e=>{"Escape"===e.key&&(s.remove(),document.removeEventListener("keydown",l))};document.addEventListener("keydown",l),s.appendChild(o),s.appendChild(a),s.appendChild(c);const d=document.createElement("div");d.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0,0,0,0.5);\n      z-index: 10000;\n    ",d.addEventListener("click",()=>{d.remove(),s.remove(),document.removeEventListener("keydown",l)}),document.body.appendChild(d),document.body.appendChild(s)}showError(e){const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #dc3545;\n      color: white;\n      padding: 12px 16px;\n      border-radius: 4px;\n      z-index: 10000;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n    ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},3e3)}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null);const e=document.querySelector(".drafty-popup");e&&e.remove();const t=document.querySelector('div[style*="rgba(0,0,0,0.5)"]');t&&t.remove(),this.isInitialized=!1}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{(new i).init()}):(new i).init()})();